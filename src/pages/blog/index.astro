---
import BaseLayout from '@layouts/BaseLayout.astro';
import PostCard from '@components/PostCard.astro';
import SearchIsland from '@components/SearchIsland.tsx';
import { getCollection } from 'astro:content';
import { Icon } from 'lucide-astro';

const allPosts = (await getCollection('blog')).sort(
  (a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime()
);

const allTags = Array.from(new Set(allPosts.flatMap((post) => post.data.tags))).sort();
const allCategories = Array.from(new Set(allPosts.map((post) => post.data.category))).sort();

const postsForSearch = allPosts.map((post) => ({
  slug: post.slug,
  title: post.data.title,
  description: post.data.description,
  tags: post.data.tags,
}));
---

<BaseLayout title="Blog" description="Browse all blog posts and articles">
  <div class="container-custom py-12">
    <div class="mb-12">
      <h1 class="text-4xl font-bold mb-4 text-text-primary">Blog</h1>
      <p class="text-lg text-text-secondary">
        Discover articles, tutorials, and insights on modern web development.
      </p>
    </div>

    <!-- Search Bar -->
    <div class="mb-8">
      <SearchIsland client:load posts={postsForSearch} />
    </div>

    <!-- Filters -->
    <div class="mb-8 flex flex-wrap gap-4 items-center">
      <span class="text-sm font-medium text-text-secondary">Filter by:</span>
      
      {allCategories.length > 0 && (
        <div class="flex flex-wrap gap-2">
          <span class="text-sm text-text-secondary">Categories:</span>
          {allCategories.map((category) => (
            <a
              href={`#category-${category.toLowerCase()}`}
              class="text-sm px-3 py-1 rounded-full border border-border bg-bg-secondary text-text-primary hover:bg-bg-primary transition-colors"
            >
              {category}
            </a>
          ))}
        </div>
      )}
      
      {allTags.length > 0 && (
        <div class="flex flex-wrap gap-2">
          <span class="text-sm text-text-secondary">Tags:</span>
          {allTags.slice(0, 10).map((tag) => (
            <a
              href={`#tag-${tag.toLowerCase()}`}
              class="text-sm px-3 py-1 rounded-full border border-border bg-bg-secondary text-text-primary hover:bg-bg-primary transition-colors"
            >
              {tag}
            </a>
          ))}
        </div>
      )}
    </div>

    <!-- Posts Grid -->
    {allPosts.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {allPosts.map((post) => (
          <PostCard post={post} />
        ))}
      </div>
    ) : (
      <div class="text-center py-12">
        <Icon name="file-text" size={48} class="mx-auto mb-4 text-text-secondary" />
        <p class="text-lg text-text-secondary">No posts found.</p>
      </div>
    )}
  </div>
</BaseLayout>
